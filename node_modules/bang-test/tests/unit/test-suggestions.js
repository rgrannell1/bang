
"use strict"





var servers   = require('bang-test/tests/fuzz/server-config')
var commons   = require('bang-test/commons/commons')
var constants = require('bang-test/commons/constants')
var engines   = require('../../../../bang/data/engines.json')
var deploy    = require('bang-test/tests/fuzz/deploy')


var request   = require('request')





describe('server suggestions resolve as expected', function ( ) {

	var state
	this.timeout(10000)

	before(done => {

		deploy.normal(servers.suggestions, result => {

			state = result
			done( )

		})

	})

	it('resolves and parses results from each suggestion server', done => {

		var testSuggestion = 'suggestion'

		commons.foldAsync(
			(results, engine, next) => {

				if (!engine.suggestTemplate) {8
					next(results)
				}

				var path    = engine.patterns[0] + ' path'
				var url     = commons.bangUrl.suggest(8025, path)

				request(url, (err, res, body) => {

					next( results.concat({
						path,
						err,
						statusCode: res
							? res.statusCode
							: null,
						body: body
							? body.toString( )
							: null
					}) )

				})

			},
			engines,
			results => {

				console.log(results.length)
				done( )

			},
			[ ]
		)

	})

	after(done => {

		state.server.server.close(( ) => {
			setTimeout(done, constants.times.SERVER_CLOSE)
		})

	})

})
