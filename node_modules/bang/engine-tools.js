
"use strict"




var is             = require('is')
var URL            = require('url')

var constants      = require('bang/commons/constants')




var engineTools = { }




engineTools.asPatternRegExp = word => {

	engineTools.asPatternRegExp.precond(word)

	var WORD_BOUNDARY = constants.regex.WORD_BOUNDARY
	var escapedWord   = word.split('').map(char => `[${char}]`).join('')

	return new RegExp(WORD_BOUNDARY + escapedWord + WORD_BOUNDARY, 'i')

}

engineTools.asPatternRegExp.precond = word => {

	is.always.string(word)

	var metacharacters = [']', '\\', '^', '-']

	word.split('').forEach(char => {

		var isMetacharacter = metacharacters.indexOf(char) !== -1

		if (isMetacharacter) {
			throw Error(`${char} in ${word} is a metacharacter and cannot currently be escaped.`)
		}

	})

}





engineTools.extractSearchTerms = (rawQuery, engine) => {

	engineTools.extractSearchTerms.precond(rawQuery, engine)

	return engine.patterns.reduce((query, pattern) => {
		return query.replace(engineTools.asPatternRegExp(pattern), '')
	}, rawQuery)

}

engineTools.extractSearchTerms.precond = (rawQuery, engine) => {

	is.always.string(rawQuery)
	is.always.object(engine)

}





engineTools.testQueryMatch = (rawQuery, engine) => {

	engineTools.testQueryMatch.precond(rawQuery, engine)

	return engine.patterns.some(pattern => {
		return engineTools.asPatternRegExp(pattern).test(rawQuery)
	})

}

engineTools.testQueryMatch.precond = (rawQuery, engine) => {

	is.always.string(rawQuery)
	is.always.object(engine)

}





engineTools.defaultEngine = engines => {

	engineTools.defaultEngine.precond(engines)

	for (var ith = 0; ith < engines.length; ++ith) {

		if (engines[ith].isDefault) {
			return engines[ith]
		}

	}

	throw Error('could not find default search engine.')
}

engineTools.defaultEngine.precond = engines => {
	is.always.array(engines)
}




engineTools.findMatchingEngine = (rawQuery, engines) => {

	engineTools.findMatchingEngine.precond(rawQuery)

	var matchingEngines = engines.filter(engineTools.testQueryMatch.bind({ }, rawQuery))

	return matchingEngines.length > 0
		? matchingEngines[0]
		: engineTools.defaultEngine(engines)

}

engineTools.findMatchingEngine.precond = rawQuery => {
	is.always.string(rawQuery)
}





engineTools.searchTermsToUrl = (searchTerms, engine) => {

	engineTools.searchTermsToUrl.precond(searchTerms, engine)

	return searchTerms.length === 0
		? engine.baseUrl
		: URL.parse(engine.searchTemplate.replace(/{searchTerms}/g, searchTerms), true).href

}

engineTools.searchTermsToUrl.precond = (searchTerms, engine) => {

	is.always.string(searchTerms)
	is.always.object(engine)

}





engineTools.suggestTermsToUrl = (searchTerms, engine) => {

	engineTools.suggestTermsToUrl.precond(searchTerms, engine)

	engineTools.searchTermsToUrl.precond(searchTerms, engine)

	return searchTerms.length === 0
		? engine.baseUrl
		: URL.parse(engine.suggestTemplate.replace(/{searchTerms}/g, searchTerms), true).href

}

engineTools.suggestTermsToUrl.precond = (searchTerms, engine) => {

	is.always.string(searchTerms)
	is.always.object(engine)

}





module.exports = engineTools
